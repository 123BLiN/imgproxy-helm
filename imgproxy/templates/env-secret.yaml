apiVersion: v1
kind: Secret
metadata:
  name: {{ template "imgproxy.fullname" $ }}-env-secrets
  labels:
    app: {{ template "imgproxy.fullname" $ }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
type: kubernetes.io/Opaque
data: {{/* https://docs.imgproxy.net/#/configuration?id=url-signature */}}
  {{- with .Values.features.urlSignature -}}
  {{- if .enabled }}
  IMGPROXY_KEY: {{ .key | required "Hex-encoded key for URL encoding at features.urlSignature.key" | b64enc | quote }}
  IMGPROXY_SALT: {{ .salt | required "Hex-encoded salt for URL encoding at features.urlSignature.salt" | b64enc | quote }}
  {{- if .signatureSize }}
  IMGPROXY_SIGNATURE_SIZE: {{ .signatureSize | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=server */}}
  {{- with .Values.features.server }}
  {{- if .readTimeout }}
  IMGPROXY_READ_TIMEOUT: {{ .readTimeout | quote }}
  {{- end }}
  {{- if .writeTimeout }}
  IMGPROXY_WRITE_TIMEOUT: {{ .writeTimeout | quote }}
  {{- end }}
  {{- if .keepAliveTimeout }}
  IMGPROXY_KEEP_ALIVE_TIMEOUT: {{ .keepAliveTimeout | quote }}
  {{- end }}
  {{- if .downloadTimeout }}
  IMGPROXY_DOWNLOAD_TIMEOUT: {{ .downloadTimeout | quote }}
  {{- end }}
  {{- if .concurrency }}
  IMGPROXY_CONCURRENCY: {{ .concurrency | quote }}
  {{- end }}
  {{- if .maxClients }}
  IMGPROXY_MAX_CLIENTS: {{ .maxClients | quote }}
  {{- end }}
  {{- if .ttl }}
  IMGPROXY_TTL: {{ .ttl | quote }}
  {{- end }}
  IMGPROXY_CACHE_CONTROL_PASSTHROUGH: {{ .cacheControlPassthrough | empty | not | quote }}
  IMGPROXY_SET_CANONICAL_HEADER: {{ .setCanonicalHeader | empty | not | quote }}
  IMGPROXY_SO_REUSEPORT: {{ .soReuseport | empty | not | quote }}
  {{- if .pathPrefix }}
  IMGPROXY_PATH_PREFIX: {{ .pathPrefix | quote }}
  {{- end }}
  {{- if .userAgent }}
  IMGPROXY_USER_AGENT: {{ .userAgent | quote }}
  {{- end }}
  IMGPROXY_USE_ETAG: {{ .useEtag | empty | not | quote }}
  {{- if .customRequestHeaders }}
  IMGPROXY_CUSTOM_REQUEST_HEADERS: {{ .customRequestHeaders | quote }}
  {{- end }}
  {{- if .customResponseHeaders }}
  IMGPROXY_CUSTOM_RESPONSE_HEADERS: {{ .customResponseHeaders | quote }}
  {{- end }}
  {{- if .customHeadersSeparator }}
  IMGPROXY_CUSTOM_HEADERS_SEPARATOR: {{ .customHeadersSeparator | quote }}
  {{- end }}
  IMGPROXY_ENABLE_DEBUG_HEADERS: {{ .enableDebugHeaders | empty | not | quote }}
  {{- end }}

  {{/* https://docs.imgproxy.net/#/configuration?id=security */}}
  {{- with .Values.features.security }}
  {{- if .secret }}
  IMGPROXY_SECRET: {{ .secret | b64enc | quote }}
  {{- end }}
  {{- if .maxSrcResolution }}
  IMGPROXY_MAX_SRC_RESOLUTION: {{ .maxSrcResolution | quote }}
  {{- end }}
  {{- if .maxSrcFileSize }}
  IMGPROXY_MAX_SRC_FILE_SIZE: {{ .maxSrcFileSize | quote }}
  {{- end }}
  {{- if .maxAnimationFrames }}
  IMGPROXY_MAX_ANIMATION_FRAMES: {{ .maxAnimationFrames | quote }}
  {{- end }}
  {{- if .maxSvgCheckBytes }}
  IMGPROXY_MAX_SVG_CHECK_BYTES: {{ .maxSvgCheckBytes | quote }}
  {{- end }}
  {{- if .allowOrigin }}
  IMGPROXY_ALLOW_ORIGIN: {{ .allowOrigin | quote }}
  {{- end }}
  {{- if .allowedSources }}
  IMGPROXY_ALLOWED_SOURCES: {{ .allowedSources | quote }}
  {{- end }}
  IMGPROXY_IGNORE_SSL_VERIFICATION: {{ .ignoreSslVerification | empty | not | quote }}
  IMGPROXY_DEVELOPMENT_ERRORS_MODE: {{ .developmentErrorsMode | empty | not | quote }}
  {{- end }}

  {{/* https://docs.imgproxy.net/#/configuration?id=compression */}}
  {{- with .Values.features.compression }}
  {{- if .quality }}
  IMGPROXY_QUALITY: {{ .quality | quote }}
  {{- end }}
  {{- if .formatQuality }}
  IMGPROXY_FORMAT_QUALITY: {{ .formatQuality | quote }}
  {{- end }}
  {{- if .gzipCompression }}
  IMGPROXY_GZIP_COMPRESSION: {{ .gzipCompression | quote }}
  {{- end }}
  IMGPROXY_JPEG_PROGRESSIVE: {{ .jpegProgressive | empty | not | quote }}
  IMGPROXY_JPEG_NO_SUBSAMPLE: {{ .jpegNoSubsample | empty | not | quote }}
  IMGPROXY_JPEG_TRELLIS_QUANT: {{ .jpegTrellisQuant | empty | not | quote }}
  IMGPROXY_JPEG_OVERSHOOT_DERINGING: {{ .jpegOvershootDeringing | empty | not | quote }}
  IMGPROXY_JPEG_OPTIMIZE_SCANS: {{ .jpegOptimizeScans | empty | not | quote }}
  {{- if .jpegQuantTable -}}
  {{- with atoi (toString .jpegQuantTable) -}}
  {{- if or (lt . 0) (gt . 8) }}
  {{- fail "Quantization table supports values 0-8 at features.compression.jpegQuantTable" -}}
  {{- end -}}
  {{- end }}
  IMGPROXY_JPEG_QUANT_TABLE: {{ .jpegQuantTable | quote }}
  {{- end }}
  IMGPROXY_PNG_INTERLACED: {{ .pngInterlaced | empty | not | quote }}
  {{- if .pngQuantize }}
  IMGPROXY_PNG_QUANTIZE: {{ .pngQuantize | quote }}
  {{- if .pngQuantizationColors }}
  {{- with atoi (toString .pngQuantizationColors) -}}
  {{- if or (lt . 2) (gt . 256) }}
  {{- fail "Maximum number of quantization palette entries should be between 2 and 256 at features.compression.pngQuantizationColors" -}}
  {{- end -}}
  {{- end }}
  IMGPROXY_PNG_QUANTIZATION_COLORS: {{ .pngQuantizationColors | quote }}
  {{- end -}}
  {{- end }}
  IMGPROXY_GIF_OPTIMIZE_FRAMES: {{ .gifOptimizeFrames | empty | not | quote }}
  {{- if .gifOptimizeTransparency -}}
  IMGPROXY_GIF_OPTIMIZE_TRANSPARENCY: "true"
  {{- end }}
  {{- if .avifSpeed }}
  {{- with atoi (toString .avifSpeed) -}}
  {{- if or (lt . 2) (gt . 8) }}
  {{- fail "CPU effort spent improving compression supports values 0-8 at features.compression.avifSpeed" -}}
  {{- end -}}
  {{- end }}
  IMGPROXY_AVIF_SPEED: {{ .avifSpeed | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=avifwebp-support-detection */}}
  {{- with .Values.features.formatsSupportDetection }}
  IMGPROXY_ENABLE_WEBP_DETECTION: {{ .enableWebpDetection | empty | not | quote }}
  IMGPROXY_ENFORCE_WEBP: {{ .enforceWebp | empty | not | quote }}
  IMGPROXY_ENABLE_AVIF_DETECTION: {{ .enableAvifDetection | empty | not | quote }}
  IMGPROXY_ENFORCE_AVIF: {{ .enforceAvif | empty | not | quote }}
  {{- end }}

  {{/* https://docs.imgproxy.net/#/configuration?id=client-hints-support */}}
  {{- with .Values.features.clientHintsSupport }}
  IMGPROXY_ENABLE_CLIENT_HINTS: {{ .enableClientHints | empty | not | quote }}
  {{- end }}

  {{/* https://docs.imgproxy.net/#/configuration?id=video-thumbnails */}}
  {{- with .Values.features.videoThumbnails }}
  IMGPROXY_ENABLE_VIDEO_THUMBNAILS: {{ .enableVideoThumbnails | empty | not | quote }}
  {{- if .videoThumbnailProbeSize }}
  IMGPROXY_VIDEO_THUMBNAIL_PROBE_SIZE: {{ .videoThumbnailProbeSize | quote }}
  {{- end }}
  {{- if .videoThumbnailMaxAnalyzeDuration }}
  IMGPROXY_VIDEO_THUMBNAIL_MAX_ANALYZE_DURATION: {{ .videoThumbnailMaxAnalyzeDuration | quote }}
  {{- end }}
  {{- if .videoThumbnailSecond }}
  IMGPROXY_VIDEO_THUMBNAIL_SECOND: {{ .videoThumbnailSecond | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=watermark */}}
  {{- with .Values.features.watermark }}
  {{- if .watermarkData }}
  IMGPROXY_WATERMARK_DATA: {{ .watermarkData | quote }}
  {{- end }}
  {{- if .watermarkPath }}
  IMGPROXY_WATERMARK_PATH: {{ .watermarkPath | quote }}
  {{- end }}
  {{- if .watermarkUrl }}
  IMGPROXY_WATERMARK_URL: {{ .watermarkUrl | quote }}
  {{- end }}
  {{- if .watermarkOpacity }}
  IMGPROXY_WATERMARK_OPACITY: {{ .watermarkOpacity | quote }}
  {{- end }}
  {{- if .watermarkCacheSize }}
  IMGPROXY_WATERMARK_CACHE_SIZE: {{ .watermarkCacheSize | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=unsharpening */}}
  {{- with .Values.features.unsharpening }}
  {{- if .unsharpeningMode }}
  {{- if not (has .unsharpeningMode (list "auto" "none" "always")) -}}
  {{- fail "The following modes are supported: `auto`, `none`, `always` at features.unsharpening.unsharpeningMode" -}}
  {{- end }}
  IMGPROXY_UNSHARPENING_MODE: {{ .unsharpeningMode | quote }}
  {{- end }}
  {{- if .unsharpeningWeight }}
  IMGPROXY_UNSHARPENING_WEIGHT: {{ .unsharpeningWeight | quote }}
  {{- end }}
  {{- if .unsharpeningDividor }}
  IMGPROXY_UNSHARPENING_DIVIDOR: {{ .unsharpeningDividor | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=fallback-image */}}
  {{- with .Values.features.fallbackImage }}
  {{- if .fallbackImageData }}
  IMGPROXY_FALLBACK_IMAGE_DATA: {{ .fallbackImageData | quote }}
  {{- end }}
  {{- if .fallbackImagePath }}
  IMGPROXY_FALLBACK_IMAGE_PATH: {{ .fallbackImagePath | quote }}
  {{- end }}
  {{- if .fallbackImageUrl }}
  IMGPROXY_FALLBACK_IMAGE_URL: {{ .fallbackImageUrl | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=skip-processing */}}
  {{- with .Values.features.skipProcessing }}
  IMGPROXY_SKIP_PROCESSING_FORMATS: {{ .skipProcessingFormats | empty | not | quote }}
  {{- end }}

  {{/* https://docs.imgproxy.net/#/configuration?id=presets */}}
  {{- with .Values.features.presets }}
  {{- if .definitions }}
  IMGPROXY_PRESETS: {{ .definitions | quote }}
  IMGPROXY_ONLY_PRESETS: {{ .onlyPresets | empty | not | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=serving-files-from-amazon-s3 */}}
  {{- with .Values.features.aws }}
  {{- if .enabled }}
  IMGPROXY_USE_S3: "true"
  AWS_ACCESS_KEY_ID: {{ .accessKeyId | required "AWS access key ID at features.aws.accessKeyId" | b64enc | quote }}
  AWS_SECRET_ACCESS_KEY: {{ .secretAccessKey | required "AWS secret access key at features.aws.secretAccessKey" | b64enc | quote }}
  {{- if .s3Region }}
  IMGPROXY_S3_REGION: {{ .s3Region | quote }}
  {{- end }}
  {{- if .s3Endpoint }}
  IMGPROXY_S3_ENDPOINT: {{ .s3Endpoint | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=serving-files-from-google-cloud-storage */}}
  {{- with .Values.features.gcs }}
  {{- if .enabled }}
  IMGPROXY_USE_GCS: "true"
  IMGPROXY_GCS_KEY: {{ .jsonKey | required "Google Cloud JSON key at features.gcs.jsonKey" | b64enc | quote }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=serving-files-from-azure-blob-storage */}}
  {{- with .Values.features.azure }}
  {{- if .enabled }}
  IMGPROXY_USE_ABS: "true"
  IMGPROXY_ABS_KEY: {{ .accountKey | required "Azure account key at features.abs.accountKey" | b64enc | quote }}
  IMGPROXY_ABS_NAME: {{ .accountName | required "Azure account name at features.abs.accountName" | quote }}
  {{- if .endpoint }}
  IMGPROXY_ABS_ENDPOINT: {{ .endpoint | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=new-relic-metrics */}}
  {{- with .Values.features.newRelic }}
  {{- if .enabled }}
  IMGPROXY_NEW_RELIC_KEY: {{ .licenseKey | required "NewRelic license key at features.newRelic.licenseKey" | b64enc | quote }}
  IMGPROXY_NEW_RELIC_APP_NAME: {{ .appName | required "NewRelic application name at features.newRelic.appName" | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=prometheus-metrics */}}
  {{- with .Values.features.prometheus }}
  {{- if .enabled }}
  IMGPROXY_PROMETHEUS_BIND: ":8081"
  {{- if .namespace }}
  IMGPROXY_PROMETHEUS_NAMESPACE: {{ .namespace | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=error-reporting */}}
  {{- with .Values.features.errorReporting }}
  {{- with .bugsnag }}
  {{- if .enabled }}
  IMGPROXY_BUGSNAG_KEY: {{ .key | required "Bugsnag API key at features.errorReporting.bugsnag.key" | b64enc | quote }}
  {{- if .env }}
  IMGPROXY_BUGSNAG_STAGE: {{ .env | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}
  {{- with .honeybadger }}
  {{- if .enabled }}
  IMGPROXY_HONEYBADGER_KEY: {{ .key | required "Honeybadger API key at features.errorReporting.honeybadger.key" | b64enc | quote }}
  {{- if .honeybadgerEnv }}
  IMGPROXY_HONEYBADGER_ENV: {{ .env | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}
  {{- with .sentry }}
  {{- if .enabled }}
  IMGPROXY_SENTRY_DSN: {{ .dsn | required "Sentry DSN at features.errorReporting.sentry.dsn" | b64enc | quote }}
  {{- if .env }}
  IMGPROXY_SENTRY_ENVIRONMENT: {{ .env | quote }}
  {{- end }}
  {{- if .release }}
  IMGPROXY_SENTRY_RELEASE: {{ .release | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}
  IMGPROXY_REPORT_DOWNLOADING_ERRORS: {{ .reportDownloadingErrors | empty | not | quote }}
  {{- end }}

  {{/* https://docs.imgproxy.net/#/configuration?id=log */}}
  {{- with .Values.features.logging }}
  {{- if .logFormat }}
  {{- if not (has .logFormat (list "pretty" "structured" "json")) -}}
  {{- fail "The following formats are supported: `pretty`, `structured`, `json` at features.logging.logFormat" -}}
  {{- end }}
  IMGPROXY_LOG_FORMAT: {{ .logFormat | quote }}
  {{- end }}
  {{- if .logLevel }}
  {{- if not (has .logLevel (list "error" "warn" "info" "debug")) -}}
  {{- fail "The following levels are supported: `error`, `warn`, `info`, and `debug` at features.logging.logLevel" -}}
  {{- end }}
  IMGPROXY_LOG_LEVEL: {{ .logLevel | quote }}
  {{- end }}
  {{- with .syslog }}
  {{- if .enabled }}
  IMGPROXY_SYSLOG_ENABLE: "true"
  {{- if .level }}
  {{- if not (has .level (list "crit" "error" "warning" "info")) -}}
  {{- fail "The following levels are supported: `crit`, `error`, `warning`, and `info` at features.logging.syslog.level" -}}
  {{- end }}
  IMGPROXY_SYSLOG_LEVEL: {{ .level | quote }}
  {{- end }}
  {{- if .network }}
  {{- if not (has .network (list "tcp" "tcp4" "tcp6" "udp" "udp4" "udp6" "ip" "ip4" "ip6" "unix" "unixgram" "unixpacket")) -}}
  {{- fail "The following syslog networks are supported: `tcp`, `tcp4`, `tcp6`, `udp`, `udp4`, `udp6`, `ip`, `ip4`, `ip6`, `unix`, `unixgram`, and `unixpacket` at features.logging.syslog.network" -}}
  {{- end }}
  IMGPROXY_SYSLOG_NETWORK: {{ .network | quote }}
  {{- if .address }}
  IMGPROXY_SYSLOG_ADDRESS: {{ .address | quote }}
  {{- end }}
  {{- end -}}
  {{- if .tag }}
  IMGPROXY_SYSLOG_TAG: {{ .tag | quote }}
  {{- end }}
  {{- end -}}
  {{- end -}}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=memory-usage-tweaks */}}
  {{- with .Values.features.memoryUsageTweaks }}
  {{- if .downloadBufferSize }}
  IMGPROXY_DOWNLOAD_BUFFER_SIZE: {{ .downloadBufferSize | quote }}
  {{- end }}
  {{- if .gzipBufferSize }}
  IMGPROXY_GZIP_BUFFER_SIZE: {{ .gzipBufferSize | quote }}
  {{- end }}
  {{- if .freeMemoryInterval }}
  IMGPROXY_FREE_MEMORY_INTERVAL: {{ .freeMemoryInterval | quote }}
  {{- end }}
  {{- if .bufferPoolCalibrationThreshold }}
  IMGPROXY_BUFFER_POOL_CALIBRATION_THRESHOLD: {{ .bufferPoolCalibrationThreshold | quote }}
  {{- end }}
  {{- end -}}

  {{/* https://docs.imgproxy.net/#/configuration?id=miscellaneous */}}
  {{- with .Values.features.miscellaneous }}
  {{- if .baseUrl }}
  IMGPROXY_BASE_URL: {{ .baseUrl | quote }}
  {{- end }}
  IMGPROXY_USE_LINEAR_COLORSPACE: {{ .useLinearColorspace | empty | not | quote }}
  IMGPROXY_DISABLE_SHRINK_ON_LOAD: {{ .disableShrinkOnLoad | toString | eq "false" | not | quote }}
  IMGPROXY_STRIP_METADATA: {{ .stripMetadata | toString | eq "false" | not | quote }}
  IMGPROXY_STRIP_COLOR_PROFILE: {{ .stripColorProfile | toString | eq "false" | not | quote }}
  IMGPROXY_AUTO_ROTATE: {{ .autoRotate | empty | not | quote }}
  {{- end }}
